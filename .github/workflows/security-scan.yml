name: Security Scan

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run TruffleHog Secret Scanner
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  pattern-scan:
    name: Scan for Sensitive Patterns
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for personal information
        run: |
          # Create temporary file for results
          RESULTS=${{ runner.temp }}/scan-results.txt
          touch "$RESULTS"
          FOUND=0

          # Check for email addresses (excluding examples)
          echo "Checking for email addresses..."
          if grep -rn -E "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b" \
            --include="*.md" --include="*.yaml" --include="*.yml" --include="*.json" . 2>/dev/null | \
            grep -iv "example\.com\|company\.com\|your-email\|@github\|@gitlab\|@anthropic\|foxj77" \
            >> "$RESULTS" 2>/dev/null; then
            FOUND=1
          fi

          # Check for IP addresses (excluding metadata and localhost)
          echo "Checking for IP addresses..."
          if grep -rn -E "([0-9]{1,3}\.){3}[0-9]{1,3}" \
            --include="*.md" --include="*.yaml" --include="*.yml" . 2>/dev/null | \
            grep -v "169\.254\.169\.254\|127\.0\.0\.1\|0\.0\.0\.0\|192\.168\.\|172\.16\.\|10\.\|203\.0\.113" \
            >> "$RESULTS" 2>/dev/null; then
            FOUND=1
          fi

          # Check for potential secret patterns
          echo "Checking for secret patterns..."
          if grep -rn -i "api[_-]key\|secret.*=.*['\"][^'\"]{8,}['\"]\|password.*=.*['\"][^'\"]{8,}['\"]\|token.*=.*['\"][^'\"]{8,}['\"]" \
            --include="*.md" --include="*.yaml" --include="*.yml" --include="*.json" . 2>/dev/null | \
            grep -v "example\|placeholder\|your-.*\|xxx\|\*\*\*" \
            >> "$RESULTS" 2>/dev/null; then
            FOUND=1
          fi

          # Report results
          if [ "$FOUND" -eq 1 ] && [ -s "$RESULTS" ]; then
            echo "⚠️ Potential sensitive information found:"
            cat "$RESULTS"
            echo ""
            echo "Please review and remove any sensitive information before merging."
            exit 1
          else
            echo "✅ No sensitive patterns detected"
          fi

  credential-scan:
    name: Scan for Common Credentials
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shhhit
        run: |
          curl -sSL https://raw.githubusercontent.com/anchore/grype/main/install/install.sh | sh -s -- -b /usr/local/bin

      - name: Run credential scan patterns
        run: |
          RESULTS=${{ runner.temp }}/cred-results.txt
          touch "$RESULTS"
          FOUND=0

          # AWS Access Key pattern
          if grep -rn -E "(AWS|aws).*(access[_-]?key|secret[_-]?key).*[=:] ?['\"]?AKIA[0-9A-Z]{16}" \
            --include="*.md" --include="*.yaml" --include="*.yml" --include="*.json" . 2>/dev/null >> "$RESULTS"; then
            FOUND=1
          fi

          # GitHub token pattern
          if grep -rn -E "ghp_[a-zA-Z0-9]{36}|gho_[a-zA-Z0-9]{36}|ghu_[a-zA-Z0-9]{36}" \
            --include="*.md" --include="*.yaml" --include="*.yml" --include="*.json" . 2>/dev/null >> "$RESULTS"; then
            FOUND=1
          fi

          # Generic API key patterns (hex strings 20+ chars)
          if grep -rn -E "(api[_-]?key|apikey|access[_-]?token|auth[_-]?token).*[=:] ?['\"]?[a-f0-9]{20,}['\"]?" \
            --include="*.md" --include="*.yaml" --include="*.yml" --include="*.json" . 2>/dev/null | \
            grep -v "example\|xxx\|\*\*\*\|schema\|draft-2020-12" >> "$RESULTS"; then
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ] && [ -s "$RESULTS" ]; then
            echo "⚠️ Possible credentials found:"
            cat "$RESULTS"
            echo ""
            echo "Please review and ensure these are not real credentials."
            exit 1
          else
            echo "✅ No credential patterns detected"
          fi

  url-scan:
    name: Scan for Internal URLs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for internal/private URLs
        run: |
          RESULTS=${{ runner.temp }}/url-results.txt
          touch "$RESULTS"
          FOUND=0

          # Check for potentially internal URLs
          if grep -rn -E "https?://[a-z0-9.-]+\.[a-z]{2,}" \
            --include="*.md" --include="*.yaml" --include="*.yml" . 2>/dev/null | \
            grep -iv \
            -e "github\.com" \
            -e "gitlab\.com" \
            -e "bitnami\.com" \
            -e "example\.com" \
            -e "company\.com" \
            -e "kubernetes\.io" \
            -e "helm\.sh" \
            -e "fluxcd\.io" \
            -e "anthropic\.com" \
            -e "localhost" \
            -e "127\.0\.0\.1" \
            -e "169\.254\.169\.254" \
            -e "json-schema\.org" \
            -e "raw\.githubusercontent\.com" \
            -e "rekor\.sigstore\.dev" \
            -e "charts\.bitnami\.com" \
            -e "management\.azure\.com" \
            -e "artifacthub\.io" \
            >> "$RESULTS" 2>/dev/null; then

            if [ -s "$RESULTS" ]; then
              FOUND=1
            fi
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo "⚠️ Non-standard URLs found (please review):"
            cat "$RESULTS"
            echo ""
            echo "If these are public documentation URLs, consider adding to the exception list."
            echo "If they are internal URLs, please remove them."
            exit 1
          else
            echo "✅ No internal URLs detected"
          fi

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, pattern-scan, credential-scan, url-scan]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.secret-scan.result }}" != "success" ] || \
             [ "${{ needs.pattern-scan.result }}" != "success" ] || \
             [ "${{ needs.credential-scan.result }}" != "success" ] || \
             [ "${{ needs.url-scan.result }}" != "success" ]; then
            echo "❌ Security scans failed. Please review the failed jobs above."
            exit 1
          else
            echo "✅ All security scans passed"
          fi
